# Example: Azure DevOps Pipeline for BingoAI
# This pipeline builds and deploys the application with environment variable replacement
# Supports Google and Facebook OAuth authentication

trigger:
  branches:
    include:
      - master
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: BingoAI-Production # Variable group in Azure DevOps containing:
                               # - GoogleClientId
                               # - FacebookAppId
                               # - FacebookAppSecret

stages:
  - stage: Build
    displayName: 'Build Application'
    jobs:
      - job: BuildFrontend
        displayName: 'Build Angular Frontend'
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '18.x'
            displayName: 'Install Node.js'

          - script: |
              cd bingoai.client
              npm install
              npm run build -- --configuration production
            displayName: 'npm install and build'

          - task: replacetokens@5
            displayName: 'Replace tokens in compiled JS'
            inputs:
              rootDirectory: 'bingoai.client/dist'
              targetFiles: '**/*.js'
              encoding: 'auto'
              tokenPattern: 'custom'
              tokenPrefix: '${'
              tokenSuffix: '}'
              actionOnMissing: 'fail'
              keepToken: false
              actionOnNoFiles: 'continue'
              enableTransforms: false
              enableRecursion: false
              useLegacyPattern: false
              enableTelemetry: true
            env:
              GOOGLE_CLIENT_ID: $(GoogleClientId)   # From variable group
              FACEBOOK_APP_ID: $(FacebookAppId)     # From variable group

          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: 'bingoai.client/dist'
              ArtifactName: 'frontend'
            displayName: 'Publish Frontend Artifact'

      - job: BuildBackend
        displayName: 'Build .NET Backend'
        steps:
          - task: UseDotNet@2
            inputs:
              version: '10.x'
            displayName: 'Install .NET 10'

          - script: |
              cd BingoAI.Server
              dotnet restore
              dotnet build --configuration Release
              dotnet publish --configuration Release --output $(Build.ArtifactStagingDirectory)/backend
            displayName: 'Build and Publish Backend'

          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)/backend'
              ArtifactName: 'backend'
            displayName: 'Publish Backend Artifact'

  - stage: Deploy
    displayName: 'Deploy to Azure'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - deployment: DeployBackend
        displayName: 'Deploy Backend to App Service'
        environment: 'production'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: AzureWebApp@1
                  inputs:
                    azureSubscription: 'Azure Subscription'
                    appType: 'webApp'
                    appName: 'bingoai-backend'
                    package: '$(Pipeline.Workspace)/backend'
                    appSettings: |
                      -Authentication__Google__ClientId "$(GoogleClientId)"
                      -Authentication__Facebook__AppId "$(FacebookAppId)"
                      -Authentication__Facebook__AppSecret "$(FacebookAppSecret)"
                  displayName: 'Deploy to Azure App Service'

      - deployment: DeployFrontend
        displayName: 'Deploy Frontend to Static Web App'
        environment: 'production'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: AzureStaticWebApp@0
                  inputs:
                    app_location: '$(Pipeline.Workspace)/frontend'
                    api_location: ''
                    output_location: ''
                    azure_static_web_apps_api_token: $(StaticWebAppToken)
                  displayName: 'Deploy to Azure Static Web App'
